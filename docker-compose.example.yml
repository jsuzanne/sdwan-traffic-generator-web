version: '3.8'

# SD-WAN Traffic Generator - Production Configuration
# Version: 1.1.0-patch.7
# Last Updated: 2026-01-21

services:
  # Web Dashboard - User Interface and API
  sdwan-web-ui:
    image: jsuzanne/sdwan-web-ui:stable
    container_name: sdwan-web-ui
    dns:
      - 8.8.8.8
      - 8.8.4.4
    hostname: sdwan-web-ui

    # Port Mapping
    # Change 8080:8080 to 8081:8080 if port 8080 is already in use
    ports:
      - "8080:8080"

    # Environment Variables
    environment:
      # JWT Secret - CHANGE THIS IN PRODUCTION!
      - JWT_SECRET=your-super-secret-jwt-key-change-me-in-production

      # Configuration paths
      - CONFIG_DIR=/app/config
      - LOG_DIR=/var/log/sdwan-traffic-gen

      # Log Retention Settings
      - LOG_RETENTION_DAYS=7 # Keep logs for 7 days
      - LOG_MAX_SIZE_MB=100 # Maximum log file size (MB)

      # Optional: Node.js Settings
      - NODE_ENV=production
      - TZ=UTC # Timezone (change as needed)
      # Optional: Custom connectivity tests
      # Format: NAME:URL for HTTP, NAME:IP for PING, NAME:IP:PORT for TCP
      # - CONNECTIVITY_HTTP_1=MyApp:https://myapp.example.com
      # - CONNECTIVITY_PING_1=Gateway:10.0.0.1
      # - CONNECTIVITY_TCP_1=SSH:192.168.1.100:22

      # Volume Mounts
    volumes:
      # Configuration directory (applications.txt, interfaces.txt, etc.)
      - ./config:/app/config

      # Logs directory (traffic.log, test-results.jsonl, stats.json)
      - ./logs:/var/log/sdwan-traffic-gen

    # Restart Policy
    restart: unless-stopped

    # Health Check
    # ✅ NEW: Checks if config file exists before marking as healthy
    healthcheck:
      test: [ "CMD", "test", "-f", "/app/config/applications.txt" ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

    # Resource Limits (Optional - Uncomment to enable)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1.0'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

    # Network
    networks:
      - sdwan-network

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Traffic Generator - Background Traffic Simulation
  sdwan-traffic-gen:
    image: jsuzanne/sdwan-traffic-gen:stable
    container_name: sdwan-traffic-gen
    hostname: sdwan-traffic-gen

    # Environment Variables
    environment:
      # Traffic Generation Settings
      - SLEEP_BETWEEN_REQUESTS=1 # Seconds between requests (1 = 1 req/sec)

      # Optional: Client ID for multi-instance deployments
      - CLIENT_ID=client01

      # Optional: Timezone
      - TZ=UTC

    # Volume Mounts
    volumes:
      # Configuration directory (shared with web-ui)
      - ./config:/opt/sdwan-traffic-gen/config

      # Logs directory (shared with web-ui)
      - ./logs:/var/log/sdwan-traffic-gen

    # Restart Policy
    restart: unless-stopped

    # Dependencies
    # ✅ NEW: Wait for web-ui to be healthy before starting
    # This prevents "Configuration file not found" errors at startup
    depends_on:
      sdwan-web-ui:
        condition: service_healthy

    # Resource Limits (Optional - Uncomment to enable)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '0.5'
    #       memory: 256M
    #     reservations:
    #       cpus: '0.25'
    #       memory: 128M

    # Network
    networks:
      - sdwan-network

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Network Configuration
networks:
  sdwan-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volumes (Optional - Use named volumes instead of bind mounts)
# volumes:
#   config:
#     driver: local
#   logs:
#     driver: local

# ============================================================================
# WHAT'S NEW IN v1.1.0-patch.7
# ============================================================================
#
# ✅ Auto-detection of network interface on first start (no manual config!)
# ✅ Improved startup reliability with healthcheck
# ✅ No more "Configuration file not found" errors in logs
# ✅ Traffic generator waits for web-ui to be fully initialized
# ✅ Cleaner logs and better user experience
#
# ============================================================================
# PRODUCTION DEPLOYMENT CHECKLIST
# ============================================================================
#
# 1. Security
#    ✓ Change JWT_SECRET to a strong random value
#    ✓ Change default admin password after first login (admin/admin)
#    ✓ Use HTTPS with reverse proxy (nginx, traefik, caddy)
#    ✓ Restrict access with firewall rules
#
# 2. Configuration
#    ✓ [OPTIONAL] Create config/applications.txt with your applications
#       (Auto-generated with 67 popular SaaS apps if not present)
#    ✓ [OPTIONAL] Create config/interfaces.txt with your network interfaces
#       (Auto-detected on first start: eth0 for Docker, en0 for macOS)
#    ✓ Adjust LOG_RETENTION_DAYS based on your needs
#    ✓ Set appropriate SLEEP_BETWEEN_REQUESTS (1 = 1 req/sec)
#
# 3. Monitoring
#    ✓ Set up log rotation (already configured)
#    ✓ Monitor disk space for logs directory
#    ✓ Check health endpoint: http://localhost:8080/api/health
#    ✓ Enable resource limits if needed
#
# 4. Backup
#    ✓ Backup config/ directory regularly
#    ✓ Backup logs/ directory if needed for compliance
#    ✓ Test restore procedures
#
# 5. Networking
#    ✓ Ensure containers can reach internet
#    ✓ Configure DNS if needed (8.8.8.8 and 8.8.4.4 by default)
#    ✓ Open firewall ports (8080 or custom)
#
# ============================================================================
# QUICK START
# ============================================================================
#
# 1. Create directories:
#    mkdir -p config logs
#
# 2. [OPTIONAL] Create config/applications.txt:
#    See docs/TRAFFIC_GENERATOR.md for examples
#    If not created, a default list of 67 popular SaaS apps will be generated
#
# 3. Start services:
#    docker compose up -d
#
# 4. Wait for initialization (~10 seconds):
#    docker compose logs -f
#
# 5. Access dashboard:
#    http://localhost:8080
#    Default credentials: admin / admin
#
# 6. Click "Start Traffic" and monitor live traffic generation!
#
# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================
#
# You can also use a .env file instead of hardcoding values:
#
# Create .env file:
#   WEB_UI_PORT=8080
#   JWT_SECRET=your-secret-key
#   LOG_RETENTION_DAYS=7
#   LOG_MAX_SIZE_MB=100
#   SLEEP_BETWEEN_REQUESTS=1
#
# Then use in docker-compose.yml:
#   ports:
#     - "${WEB_UI_PORT}:8080"
#   environment:
#     - JWT_SECRET=${JWT_SECRET}
#
# ============================================================================
# CUSTOM CONNECTIVITY TESTS
# ============================================================================
#
# You can add custom endpoints to monitor in the Connectivity tab:
#
# HTTP/HTTPS endpoints:
#   - CONNECTIVITY_HTTP_1=MyApp:https://myapp.example.com
#   - CONNECTIVITY_HTTP_2=InternalAPI:http://192.168.1.100:8080
#
# PING endpoints (ICMP):
#   - CONNECTIVITY_PING_1=Gateway:10.0.0.1
#   - CONNECTIVITY_PING_2=DNS:8.8.8.8
#
# TCP Port checks:
#   - CONNECTIVITY_TCP_1=SSH:192.168.1.100:22
#   - CONNECTIVITY_TCP_2=DB:10.0.0.50:3306
#
# Example with all types:
#   environment:
#     - CONNECTIVITY_HTTP_1=Production-App:https://app.company.com
#     - CONNECTIVITY_HTTP_2=Staging-App:https://staging.company.com
#     - CONNECTIVITY_PING_1=HQ-Gateway:10.0.0.1
#     - CONNECTIVITY_PING_2=Branch-Gateway:192.168.100.1
#     - CONNECTIVITY_TCP_1=DB-Server:10.0.0.50:3306
#     - CONNECTIVITY_TCP_2=SSH-Bastion:10.0.0.100:22
#
# ============================================================================
# TROUBLESHOOTING
# ============================================================================
#
# Issue: Port 8080 already in use
# Solution: Change ports to "8081:8080" or any free port
#
# Issue: Cannot connect to dashboard
# Solution: Check firewall rules, ensure container is running (docker compose ps)
#
# Issue: Traffic not generating
# Solution: Check interfaces.txt, ensure network interface is correct
#
# Issue: Logs filling up disk
# Solution: Reduce LOG_RETENTION_DAYS or LOG_MAX_SIZE_MB
#
# Issue: "Configuration file not found" errors
# Solution: This is fixed in v1.1.0-patch.7! Update your docker-compose.yml
#
# For more help: https://github.com/jsuzanne/sdwan-traffic-generator-web
#
# ============================================================================
